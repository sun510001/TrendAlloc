<!DOCTYPE html>
<html lang='en'>
<head>
  <meta charset='UTF-8'>
  <title>Backtest Console</title>
  <meta name='viewport' content='width=device-width, initial-scale=1.0'>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background:#111; color:#eee; font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif; margin:0; padding:20px; }
    .panel { background:#1e1e1e; border:1px solid #333; border-radius:8px; padding:16px; margin-bottom:16px; }
    label { display:block; font-size:12px; color:#aaa; margin-bottom:4px; }
    input, select, textarea { width:100%; padding:6px 8px; border-radius:4px; border:1px solid #444; background:#222; color:#eee; box-sizing:border-box; }
    button { padding:8px 12px; border:none; border-radius:4px; background:#0af; color:#111; font-weight:bold; cursor:pointer; }
    button:disabled { opacity:0.6; cursor:not-allowed; }
    .grid-stats { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:8px; }
    .stat-card { background:#181818; border:1px solid #333; border-radius:6px; padding:8px; }
    .stat-label { font-size:12px; color:#888; }
    .stat-value { font-size:18px; font-weight:bold; }
    .error { background:#611; border:1px solid #a33; border-radius:6px; padding:8px; margin-top:8px; display:none; }
    iframe { width:100%; height:1000px; border:none; border-radius:6px; background:#000; }
    
    .main-layout { display:flex; flex-direction:column; gap:16px; }
    .top-layout { display:flex; flex-direction:column; gap:16px; }
    .bottom-layout { display:flex; flex-direction:column; gap:16px; }
    @media (min-width: 1024px) {
      .top-layout { display:grid; grid-template-columns:400px minmax(0,1fr); gap:16px; align-items:stretch; }
    }
    .top-layout .panel { height:100%; display: flex; flex-direction: column; }
    table { width:100%; border-collapse:collapse; margin-top:8px; font-size:12px; }
    th, td { border:1px solid #333; padding:4px 6px; text-align:left; }
    th { background:#222; position: sticky; top: 0; z-index: 10; }

    /* Toggle switch for trend model */
    .toggle-wrapper { display:flex; align-items:center; gap:8px; cursor:pointer; user-select:none; }
    .toggle-track {
      width:34px;
      height:18px;
      border-radius:9999px;
      background:#333;
      position:relative;
      transition:background-color 0.2s;
      flex-shrink:0;
    }
    .toggle-thumb {
      position:absolute;
      top:2px;
      left:2px;
      width:14px;
      height:14px;
      border-radius:9999px;
      background:#ddd;
      transition:transform 0.2s;
    }
    .toggle-input:checked + .toggle-track {
      background:#2563eb;
    }
    .toggle-input:checked + .toggle-track .toggle-thumb {
      transform:translateX(16px);
    }

    /* Drag & Drop Styles */
    .asset-pool { min-height: 40px; padding: 8px; border: 1px solid #333; border-radius: 6px; background: #151515; display: flex; flex-wrap: wrap; gap: 6px; }
    .dropzone { min-height: 44px; padding: 6px; border: 2px dashed #444; border-radius: 6px; background: #222; display: flex; flex-wrap: wrap; gap: 6px; transition: border-color 0.2s; }
    .dropzone.drag-over { border-color: #0af; background: #282828; }
    .asset-chip { padding: 4px 10px; background: #333; border: 1px solid #555; border-radius: 9999px; font-size: 12px; cursor: grab; user-select: none; display: flex; align-items: center; gap: 4px; }
    .asset-chip:active { cursor: grabbing; }
    .asset-chip .remove-btn { cursor: pointer; font-weight: bold; color: #ff4444; margin-left: 4px; }
    .asset-chip.in-use { opacity: 0.4; cursor: default; }
  </style>
</head>
<body>
  <div class='max-w-[1600px] mx-auto'>
    <h1 class="text-3xl font-bold mb-2">Backtest Console</h1>
    <p class="text-gray-500 mb-6">Manage assets, configure strategy parameters, and analyze performance.</p>
    
    <div class='main-layout'>
      <div class='top-layout'>
        <!-- LEFT: Configuration Panel -->
        <div class='panel self-start'>
          <h2 class="text-lg font-bold mb-4 border-b border-gray-700 pb-2">Configuration</h2>
          <form id='backtest-form' class="flex-1 flex flex-col justify-between space-y-4">
            <div class="space-y-4">
              <!-- Basic Parameters Group -->
              <div class="grid grid-cols-2 gap-3">
                <div class="col-span-2">
                  <label>Algorithm</label>
                  <select id='algorithm' name='algorithm'></select>
                </div>
                <div class="col-span-2">
                  <label>Signal Weighted Mode</label>
                  <select id='signal_weight_mode'>
                    <option value='raw_signal_tilt'>Raw Signal Tilt</option>
                    <option value='signal_tilt_with_risk_leverage'>Signal Tilt + Risk Leverage</option>
                  </select>
                </div>
                <div>
                  <label>Initial Capital</label>
                  <input type='number' id='initial_capital' value='100000'>
                </div>
                <div>
                  <label>Rebalance Interval (days)</label>
                  <input type='number' id='rebalance_interval_days' placeholder='e.g. 30'>
                </div>
                <div>
                  <label>Start Date</label>
                  <input type='date' id='start_date' value='2016-01-01'>
                </div>
                <div>
                  <label>End Date</label>
                  <input type='date' id='end_date' value='2026-01-01'>
                </div>
                <div>
                  <label>Max Tilt (0.1 = 10%)</label>
                  <input type='number' id='max_tilt' value='0.1' step='0.05' min='0' max='1'>
                </div>
              </div>

              <!-- Asset Selection Group -->
              <div class="space-y-3 pt-2 border-t border-gray-700 mt-2">
                <div class="flex items-center justify-between">
                  <label class="text-sm font-semibold text-blue-400">Asset Pool (Drag from here)</label>
                  <button type="button" id="clear-selection-btn" class="text-[10px] px-2 py-0.5 bg-gray-700 hover:bg-red-900 rounded text-gray-300 transition-colors">Clear All</button>
                </div>
                <div id="asset-pool" class="asset-pool"></div>

                <div>
                  <label class="text-xs text-gray-400">Strategy Assets</label>
                  <div id="strategy-dropzone" class="dropzone" data-type="strategy"></div>
                  <input type='hidden' id='asset_cols'>
                </div>

                <div>
                  <label class="text-xs text-gray-400">Benchmarks</label>
                  <div id="benchmark-dropzone" class="dropzone" data-type="benchmark"></div>
                  <input type='hidden' id='benchmark_cols'>
                </div>

                <div>
                  <label class="text-xs text-gray-400">Risk Assets (Optional)</label>
                  <div id="risk-dropzone" class="dropzone" data-type="risk"></div>
                  <input type='hidden' id='risk_asset_cols'>
                </div>

                <div>
                  <label class="text-xs text-gray-400">Safe Assets (Optional)</label>
                  <div id="safe-dropzone" class="dropzone" data-type="safe"></div>
                  <input type='hidden' id='safe_asset_cols'>
                </div>

                <div class="col-span-2 space-y-2">
                  <label class="text-xs text-gray-400">Safe Allocation Mode</label>
                  <select id='safe_allocation_mode'>
                    <option value='equal_weight'>Equal Weight</option>
                    <option value='fixed_weight'>Fixed Weight</option>
                    <option value='single_asset'>Single Asset</option>
                  </select>
                  <div id="safe-fixed-weights-wrap" class="hidden">
                    <label class="text-[11px] text-gray-500">Fixed Weights (one per line, `Asset=Weight`)</label>
                    <textarea id="safe_fixed_weights_text" rows="3" placeholder="SHY=0.7&#10;IEF=0.3"></textarea>
                  </div>
                  <div id="safe-single-asset-wrap" class="hidden">
                    <label class="text-[11px] text-gray-500">Single Safe Asset</label>
                    <select id='safe_single_asset'></select>
                  </div>
                </div>
              </div>

              <!-- Trend Model Group -->
              <div class="border-t border-gray-700 pt-3 mt-3 space-y-3">
                <label class="toggle-wrapper text-sm text-gray-200">
                  <input type='checkbox' id='use_trend_model' class="toggle-input hidden" />
                  <span class="toggle-track">
                    <span class="toggle-thumb"></span>
                  </span>
                  <span>Use Trend Model</span>
                </label>
                <div id="trend-model-fields" class="space-y-3 transition-opacity duration-200">
                  <div class="grid grid-cols-2 gap-3">
                    <div>
                      <label>Model Type</label>
                      <select id='model_type'>
                        <option value='kmeans_simple'>kmeans_simple</option>
                        <option value='kmeans_window'>kmeans_window</option>
                        <option value='random_forest'>random_forest</option>
                        <option value='torch_mlp'>torch_mlp</option>
                        <option value='autoencoder'>autoencoder</option>
                        <option value='hmm'>hmm</option>
                      </select>
                    </div>
                    <div>
                      <label>Lookback Days</label>
                      <input type='number' id='model_lookback_days' value='60'>
                    </div>
                  </div>
                  <div class="grid grid-cols-2 gap-3">
                    <div>
                      <label>Model File (.pkl)</label>
                      <select id='model_path'>
                        <option value=''>[none]</option>
                      </select>
                    </div>
                    <div>
                      <label>Trend Threshold [0,1]</label>
                      <input type='number' id='model_threshold' value='0.5' step='0.05' min='0' max='1'>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Risk Leverage Group -->
              <div class="border-t border-gray-700 pt-3 mt-3 space-y-3">
                <label class="text-sm font-semibold text-blue-400">Risk Leverage Params</label>
                <div id="risk-leverage-fields" class="grid grid-cols-2 gap-3 transition-opacity duration-200">
                  <div>
                    <label>Leverage Min</label>
                    <input type='number' id='risk_leverage_min' value='0.2' step='0.005' min='0' max='1'>
                  </div>
                  <div>
                    <label>Leverage Max</label>
                    <input type='number' id='risk_leverage_max' value='1.0' step='0.005' min='0' max='1'>
                  </div>
                  <div>
                    <label>Score Lo</label>
                    <input type='number' id='risk_leverage_score_lo' value='0.2' step='0.005' min='0' max='1'>
                  </div>
                  <div>
                    <label>Score Hi</label>
                    <input type='number' id='risk_leverage_score_hi' value='0.8' step='0.005' min='0' max='1'>
                  </div>
                </div>
              </div>
            </div>

            <div class="pt-4 mt-auto">
              <button type='submit' id='run-btn' class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded transition-colors">Run Backtest</button>
              <div id='error-msg' class='error'></div>
            </div>
          </form>
        </div>

        <!-- RIGHT: Assets Management -->
        <div class='panel'>
          <h2 class="text-lg font-bold mb-4 border-b border-gray-700 pb-2">Assets Management</h2>
          <div class="flex gap-2 mb-4 items-center">
            <button type='button' id='refresh-assets-btn' class="bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded text-sm transition-colors">Refresh List</button>
            <button type='button' id='download-assets-btn' class="bg-orange-700 hover:bg-orange-600 px-3 py-1 rounded text-sm transition-colors">Download Data</button>
            <button type='button' id='process-assets-btn' class="bg-blue-700 hover:bg-blue-600 px-3 py-1 rounded text-sm transition-colors">Process Data</button>
            <label class="flex items-center gap-1 text-xs text-gray-400 ml-auto">
              <input type='checkbox' id='select-all-assets'>
              <span>Select All</span>
            </label>
          </div>
          
          <!-- Fixed height table container -->
          <div class="flex-1 min-h-0 overflow-hidden flex flex-col">
            <div class="overflow-y-auto border border-gray-800 rounded mb-4 flex-1" style="max-height: none;">
              <table id='assets-table'>
                <thead>
                  <tr>
                    <th style="width:32px; text-align:center;">Sel</th>
                    <th>Name</th>
                    <th>Ticker</th>
                    <th>Kind</th>
                    <th>Engine</th>
                    <th>Data Start</th>
                    <th>Data End</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

            <div class="mt-auto pt-4 border-t border-gray-800">
              <h3 class="text-sm font-bold mb-3 text-blue-400">Add / Edit Asset</h3>
              <form id='asset-form' class="grid grid-cols-2 gap-3">
                <input type='hidden' id='asset_original_name'>
                <div><label>Name</label><input type='text' id='asset_name'></div>
                <div><label>Ticker</label><input type='text' id='asset_ticker'></div>
                <div>
                  <label>Kind</label>
                  <select id='asset_kind'>
                    <option value='price'>price</option>
                    <option value='yield'>yield</option>
                  </select>
                </div>
                <div>
                  <label>Engine</label>
                  <select id='asset_engine'>
                    <option value=''>None</option>
                    <option value='bond'>bond</option>
                    <option value='cash'>cash</option>
                  </select>
                </div>
                <div><label>Initial Start Date</label><input type='date' id='asset_initial_start_date' value='1985-01-02'></div>
                <div><label>Duration (for bond)</label><input type='number' step='0.1' id='asset_duration' placeholder="20.0"></div>
                <div class="col-span-2 flex gap-2 pt-2">
                  <button type='submit' id='save-asset-btn' class="flex-1 bg-green-700 hover:bg-green-600 text-white font-bold py-2 rounded transition-colors text-sm">Save Asset</button>
                  <button type='button' id='new-asset-btn' class="flex-1 bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 rounded transition-colors text-sm">Clear Form</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- BOTTOM: Results -->
      <div class='bottom-layout'>
        <div id='loading' class='panel hidden text-center py-12'>
          <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500 mb-4"></div>
          <div>Processing backtest simulation, please wait...</div>
        </div>

        <div id='results-panel' class="hidden space-y-4">
          <div class='panel'>
            <h2 class="text-lg font-bold mb-4">Statistics</h2>
            <div id='stats-grid' class='grid-stats'></div>
          </div>
          <div class='panel'>
            <h2 class="text-lg font-bold mb-4">Performance Chart</h2>
            <iframe id='plot-frame' src=''></iframe>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let lastSavedAssetName = null;
    let allAssetsList = [];
    const STORAGE_KEY = 'backtest_asset_selection_v1';

    async function loadAlgorithms() {
      try {
        const res = await fetch('/api/algorithms');
        const algos = await res.json();
        const select = document.getElementById('algorithm');
        select.innerHTML = '';
        algos.forEach(a => {
          const opt = document.createElement('option');
          opt.value = a.key;
          opt.textContent = a.label;
          select.appendChild(opt);
        });
      } catch (e) { console.error('Failed to load algorithms', e); }
    }

    async function loadTrendModels() {
      try {
        const res = await fetch('/api/trend_models');
        const models = await res.json();
        const select = document.getElementById('model_path');
        if (!select) return;

        select.innerHTML = '';

        models.forEach(m => {
          const opt = document.createElement('option');
          opt.value = m.key;
          opt.textContent = m.label;
          select.appendChild(opt);
        });
      } catch (e) {
        console.error('Failed to load trend models', e);
      }
    }

    function createAssetChip(name, type = 'pool') {
      const chip = document.createElement('div');
      chip.className = 'asset-chip';
      chip.textContent = name;
      chip.draggable = true;
      chip.dataset.name = name;
      
      if (type !== 'pool') {
        const removeBtn = document.createElement('span');
        removeBtn.className = 'remove-btn';
        removeBtn.textContent = '×';
        removeBtn.onclick = (e) => {
          e.stopPropagation();
          chip.remove();
          updateHiddenInputs();
        };
        chip.appendChild(removeBtn);
      }

      chip.ondragstart = (e) => {
        e.dataTransfer.setData('text/plain', name);
        e.dataTransfer.effectAllowed = 'copyMove';
      };

      return chip;
    }

    function updateAssetPool() {
      const pool = document.getElementById('asset-pool');
      pool.innerHTML = '';
      // 只展示已 Process Data 进入 aligned_assets.csv 的资产，避免未处理资产被误用于回测/benchmarks
      allAssetsList
        .filter(asset => asset.processed)
        .forEach(asset => {
          pool.appendChild(createAssetChip(asset.name, 'pool'));
        });

      if (pool.children.length === 0) {
        const hint = document.createElement('div');
        hint.className = 'text-xs text-gray-500';
        hint.textContent = 'No processed assets in Asset Pool. Please click "Process Data" in Assets Management.';
        pool.appendChild(hint);
      }
    }

    function updateHiddenInputs() {
      const stratChips = Array.from(document.querySelectorAll('#strategy-dropzone .asset-chip'));
      document.getElementById('asset_cols').value = stratChips.map(c => c.dataset.name).join(',');

      const benchChips = Array.from(document.querySelectorAll('#benchmark-dropzone .asset-chip'));
      document.getElementById('benchmark_cols').value = benchChips.map(c => c.dataset.name).join(',');

      const riskChips = Array.from(document.querySelectorAll('#risk-dropzone .asset-chip'));
      document.getElementById('risk_asset_cols').value = riskChips.map(c => c.dataset.name).join(',');

      const safeChips = Array.from(document.querySelectorAll('#safe-dropzone .asset-chip'));
      document.getElementById('safe_asset_cols').value = safeChips.map(c => c.dataset.name).join(',');
      refreshSafeSingleAssetOptions();

      const state = {
        strategy: stratChips.map(c => c.dataset.name),
        benchmarks: benchChips.map(c => c.dataset.name),
        riskAssets: riskChips.map(c => c.dataset.name),
        safeAssets: safeChips.map(c => c.dataset.name),
        safeAllocationMode: document.getElementById('safe_allocation_mode').value,
        safeFixedWeightsText: document.getElementById('safe_fixed_weights_text').value,
        safeSingleAsset: document.getElementById('safe_single_asset').value || '',
      };
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (e) {
        console.warn('Failed to persist asset selection', e);
      }
    }

    function clearStrategyAndBenchmarks() {
      if (!confirm('Clear Strategy / Benchmarks / Risk / Safe selections?')) return;
      document.getElementById('strategy-dropzone').innerHTML = '';
      document.getElementById('benchmark-dropzone').innerHTML = '';
      document.getElementById('risk-dropzone').innerHTML = '';
      document.getElementById('safe-dropzone').innerHTML = '';
      updateHiddenInputs();
    }

    function updateTrendModelEnabled() {
      const enabled = document.getElementById('use_trend_model').checked;
      const fields = document.getElementById('trend-model-fields');
      const inputs = fields.querySelectorAll('select, input');
      inputs.forEach(el => el.disabled = !enabled);
      fields.style.opacity = enabled ? '1' : '0.4';
      fields.style.pointerEvents = enabled ? 'auto' : 'none';
    }

    function updateModelPathEnabled() {
      const modelType = document.getElementById('model_type').value;
      const modelPathSelect = document.getElementById('model_path');
      if (!modelPathSelect) return;

      if (modelType === 'kmeans_window' || modelType === 'random_forest' || modelType === 'torch_mlp') {
        modelPathSelect.disabled = false;
      } else {
        modelPathSelect.disabled = true;
        modelPathSelect.value = '';
      }
    }

    function updateRiskLeverageEnabled() {
      const mode = document.getElementById('signal_weight_mode').value;
      const enabled = mode === 'signal_tilt_with_risk_leverage';
      const fields = document.getElementById('risk-leverage-fields');
      const inputs = fields.querySelectorAll('input');
      inputs.forEach(el => el.disabled = !enabled);
      fields.style.opacity = enabled ? '1' : '0.4';
      fields.style.pointerEvents = enabled ? 'auto' : 'none';
    }

    function refreshSafeSingleAssetOptions() {
      const select = document.getElementById('safe_single_asset');
      if (!select) return;
      const prev = select.value;
      const safeNames = Array.from(document.querySelectorAll('#safe-dropzone .asset-chip'))
        .map(c => c.dataset.name)
        .filter(Boolean);

      select.innerHTML = '';
      if (safeNames.length === 0) {
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = '[none]';
        select.appendChild(opt);
        select.value = '';
        return;
      }

      safeNames.forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        select.appendChild(opt);
      });
      select.value = safeNames.includes(prev) ? prev : safeNames[0];
    }

    function updateSafeAllocationModeUI() {
      const mode = document.getElementById('safe_allocation_mode').value;
      const fixedWrap = document.getElementById('safe-fixed-weights-wrap');
      const singleWrap = document.getElementById('safe-single-asset-wrap');
      if (!fixedWrap || !singleWrap) return;
      fixedWrap.classList.toggle('hidden', mode !== 'fixed_weight');
      singleWrap.classList.toggle('hidden', mode !== 'single_asset');
      refreshSafeSingleAssetOptions();
    }

    function parseSafeFixedWeights(text) {
      const result = {};
      const raw = (text || '').trim();
      if (!raw) return result;

      const parts = raw
        .split(/\n|,/)
        .map(s => s.trim())
        .filter(Boolean);

      for (const part of parts) {
        const pair = part.split(/=|:/).map(s => s.trim());
        if (pair.length !== 2 || !pair[0] || !pair[1]) {
          throw new Error(`Invalid fixed weight entry: "${part}". Use Asset=Weight`);
        }
        const value = parseFloat(pair[1]);
        if (!Number.isFinite(value) || value < 0) {
          throw new Error(`Invalid weight for "${pair[0]}": ${pair[1]}`);
        }
        result[pair[0]] = value;
      }
      return result;
    }

    // Setup Drag and Drop
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.dropzone').forEach(zone => {
        zone.ondragover = (e) => {
          e.preventDefault();
          zone.classList.add('drag-over');
        };
        zone.ondragleave = () => {
          zone.classList.remove('drag-over');
        };
        zone.ondrop = (e) => {
          e.preventDefault();
          zone.classList.remove('drag-over');
          const name = e.dataTransfer.getData('text/plain');
          if (!name) return;
          // Prevent duplicates in same zone
          if (zone.querySelector(`[data-name="${name}"]`)) return;
          // Risk/Safe are mutually exclusive: moving to one removes it from the other.
          if (zone.dataset.type === 'risk') {
            const existing = document.querySelector(`#safe-dropzone [data-name="${name}"]`);
            if (existing) existing.remove();
          } else if (zone.dataset.type === 'safe') {
            const existing = document.querySelector(`#risk-dropzone [data-name="${name}"]`);
            if (existing) existing.remove();
          }
          const chip = createAssetChip(name, zone.dataset.type);
          zone.appendChild(chip);
          updateHiddenInputs();
        };
      });

      document.getElementById('clear-selection-btn').onclick = clearStrategyAndBenchmarks;
      document.getElementById('use_trend_model').onchange = () => {
        updateTrendModelEnabled();
        updateModelPathEnabled();
      };
      document.getElementById('model_type').onchange = updateModelPathEnabled;
      document.getElementById('signal_weight_mode').onchange = updateRiskLeverageEnabled;
      document.getElementById('safe_allocation_mode').onchange = () => {
        updateSafeAllocationModeUI();
        updateHiddenInputs();
      };
      document.getElementById('safe_fixed_weights_text').oninput = updateHiddenInputs;
      document.getElementById('safe_single_asset').onchange = updateHiddenInputs;

      updateTrendModelEnabled();
      updateModelPathEnabled();
      updateRiskLeverageEnabled();
      updateSafeAllocationModeUI();
    });

    async function loadAssets() {
      try {
        const res = await fetch('/api/assets');
        const assets = await res.json();
        allAssetsList = assets;
        updateAssetPool();

        const tbody = document.querySelector('#assets-table tbody');
        tbody.innerHTML = '';
        assets.forEach(a => {
          const tr = document.createElement('tr');
          const isDerived = !!a.derived;
          tr.innerHTML = `
            <td style="text-align:center;"><input type='checkbox' class='asset-select-checkbox' data-name="${a.name}" ${isDerived ? 'disabled title="Derived asset: no raw download/process selection"' : ''}></td>
            <td>${a.name}</td>
            <td>${a.ticker}</td>
            <td>${a.kind}</td>
            <td>${a.engine || '-'}</td>
            <td>${a.data_start_date || '-'}</td>
            <td>${a.data_end_date || '-'}</td>
            <td class="flex gap-1">
              ${isDerived
                ? "<span class='text-[10px] text-gray-400 px-2 py-1'>DERIVED</span>"
                : "<button type='button' class='edit-asset bg-gray-700 hover:bg-gray-600 px-2 py-1 text-[10px]'>EDIT</button><button type='button' class='delete-asset bg-red-900 hover:bg-red-800 px-2 py-1 text-[10px]'>DEL</button>"
              }
            </td>
          `;

          if (!isDerived) {
            tr.querySelector('.edit-asset').onclick = () => {
              document.getElementById('asset_original_name').value = a.name;
              document.getElementById('asset_name').value = a.name;
              document.getElementById('asset_ticker').value = a.ticker;
              document.getElementById('asset_kind').value = a.kind;
              document.getElementById('asset_engine').value = a.engine || '';
              document.getElementById('asset_duration').value = a.duration || '';
              document.getElementById('asset_initial_start_date').value = a.initial_start_date || '1985-01-02';
            };

            tr.querySelector('.delete-asset').onclick = async () => {
              if (!confirm(`Delete asset '${a.name}'?`)) return;
              const res = await fetch(`/api/assets/${encodeURIComponent(a.name)}`, { method: 'DELETE' });
              if (res.ok) loadAssets(); else alert('Delete failed');
            };
          }

          tbody.appendChild(tr);
        });

        if (lastSavedAssetName) {
          const checkbox = document.querySelector(`.asset-select-checkbox[data-name="${lastSavedAssetName}"]`);
          if (checkbox) checkbox.checked = true;
        }

        try {
          const saved = localStorage.getItem(STORAGE_KEY);
          if (saved) {
            const state = JSON.parse(saved);
            const stratZone = document.getElementById('strategy-dropzone');
            const benchZone = document.getElementById('benchmark-dropzone');
            const riskZone = document.getElementById('risk-dropzone');
            const safeZone = document.getElementById('safe-dropzone');
            const safeModeSelect = document.getElementById('safe_allocation_mode');
            const safeFixedWeightsText = document.getElementById('safe_fixed_weights_text');
            const safeSingleAssetSelect = document.getElementById('safe_single_asset');

            // 清空现有 chip，避免多次 loadAssets 叠加重复
            stratZone.innerHTML = '';
            benchZone.innerHTML = '';
            riskZone.innerHTML = '';
            safeZone.innerHTML = '';

            if (state.strategy && Array.isArray(state.strategy)) {
              state.strategy.forEach(name => {
                if (allAssetsList.find(a => a.name === name)) {
                  if (!stratZone.querySelector(`[data-name="${name}"]`)) {
                    stratZone.appendChild(createAssetChip(name, 'strategy'));
                  }
                }
              });
            }
            if (state.benchmarks && Array.isArray(state.benchmarks)) {
              state.benchmarks.forEach(name => {
                if (allAssetsList.find(a => a.name === name)) {
                  if (!benchZone.querySelector(`[data-name="${name}"]`)) {
                    benchZone.appendChild(createAssetChip(name, 'benchmark'));
                  }
                }
              });
            }
            if (state.riskAssets && Array.isArray(state.riskAssets)) {
              state.riskAssets.forEach(name => {
                if (allAssetsList.find(a => a.name === name)) {
                  if (!riskZone.querySelector(`[data-name="${name}"]`)) {
                    riskZone.appendChild(createAssetChip(name, 'risk'));
                  }
                }
              });
            }
            if (state.safeAssets && Array.isArray(state.safeAssets)) {
              state.safeAssets.forEach(name => {
                if (allAssetsList.find(a => a.name === name)) {
                  if (!safeZone.querySelector(`[data-name="${name}"]`)) {
                    safeZone.appendChild(createAssetChip(name, 'safe'));
                  }
                }
              });
            }
            if (safeModeSelect && state.safeAllocationMode) {
              safeModeSelect.value = state.safeAllocationMode;
            }
            if (safeFixedWeightsText && typeof state.safeFixedWeightsText === 'string') {
              safeFixedWeightsText.value = state.safeFixedWeightsText;
            }
            updateHiddenInputs();
            if (safeSingleAssetSelect && state.safeSingleAsset) {
              const exists = Array.from(safeSingleAssetSelect.options).some(
                opt => opt.value === state.safeSingleAsset
              );
              if (exists) safeSingleAssetSelect.value = state.safeSingleAsset;
            }
            updateSafeAllocationModeUI();
          }
        } catch (e) {
          console.warn('Failed to restore asset selection from storage', e);
        }
      } catch (e) { console.error('Failed to load assets', e); }
    }

    async function saveAsset(e) {
      e.preventDefault();
      const originalName = document.getElementById('asset_original_name').value || null;
      const payload = {
        name: document.getElementById('asset_name').value.trim(),
        ticker: document.getElementById('asset_ticker').value.trim(),
        kind: document.getElementById('asset_kind').value,
        engine: document.getElementById('asset_engine').value || null,
        duration: document.getElementById('asset_duration').value ? parseFloat(document.getElementById('asset_duration').value) : null,
        initial_start_date: document.getElementById('asset_initial_start_date').value || "1985-01-02"
      };

      if (!payload.name || !payload.ticker) { alert('Name and Ticker are required'); return; }

      const url = originalName ? `/api/assets/${encodeURIComponent(originalName)}` : '/api/assets';
      const method = originalName ? 'PUT' : 'POST';

      const res = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });

      if (res.ok) {
        document.getElementById('asset_original_name').value = '';
        lastSavedAssetName = payload.name;
        loadAssets();
      } else {
        const err = await res.json();
        alert(err.detail || 'Save failed');
      }
    }

    async function downloadAssets() {
      const checkboxes = Array.from(document.querySelectorAll('.asset-select-checkbox'));
      const selectedNames = checkboxes.filter(cb => cb.checked).map(cb => cb.getAttribute('data-name'));

      if (selectedNames.length === 0) {
        alert('Please select at least one asset to download.');
        return;
      }

      if (!confirm('Start incremental data update for selected assets?')) return;
      const btn = document.getElementById('download-assets-btn');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Updating...';
      
      try {
        const res = await fetch('/api/assets/download', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ names: selectedNames }),
        });
        const data = await res.json();
        if (res.status === 429) {
            alert(data.detail);
        } else if (!res.ok) {
            alert('Failed: ' + (data.detail || 'Unknown error'));
        } else {
            alert('Success: Data downloaded.');
            loadAssets();
        }
      } catch (e) { alert('Download trigger failed'); }
      finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    async function processAssets() {
      const checkboxes = Array.from(document.querySelectorAll('.asset-select-checkbox'));
      const selectedNames = checkboxes.filter(cb => cb.checked).map(cb => cb.getAttribute('data-name'));

      if (selectedNames.length === 0) {
        alert('Please select at least one asset in Assets Management before Process Data.');
        return;
      }

      if (!confirm('Start processing and aligning data? (Alignment uses all configured assets; selected assets control derived TermSpread generation)')) return;
      const btn = document.getElementById('process-assets-btn');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Processing...';

      try {
        const res = await fetch('/api/assets/process', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ names: selectedNames }),
        });
        const data = await res.json();
        if (!res.ok) {
          alert('Failed: ' + (data.detail || 'Unknown error'));
        } else {
          alert('Success: Data processed.');
          loadAssets();
        }
      } catch (e) {
        alert('Process trigger failed');
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    async function runBacktest(e) {
      e.preventDefault();
      const runBtn = document.getElementById('run-btn');
      const loading = document.getElementById('loading');
      const resultsPanel = document.getElementById('results-panel');
      const errorMsg = document.getElementById('error-msg');
      const statsGrid = document.getElementById('stats-grid');
      const plotFrame = document.getElementById('plot-frame');

      errorMsg.style.display = 'none';
      resultsPanel.classList.add('hidden');
      runBtn.disabled = true;
      loading.classList.remove('hidden');

      const useTrend = document.getElementById('use_trend_model').checked;
      const modelType = document.getElementById('model_type').value;
      const modelPathEl = document.getElementById('model_path');
      const modelPathVal = modelPathEl && modelPathEl.value ? modelPathEl.value : '';

      if (useTrend && (modelType === 'kmeans_window' || modelType === 'random_forest' || modelType === 'torch_mlp') && !modelPathVal) {
        loading.classList.add('hidden');
        runBtn.disabled = false;
        errorMsg.textContent = 'Please select a Model File when using ' + modelType + '.';
        errorMsg.style.display = 'block';
        return;
      }

      const selectedAssetCols = document.getElementById('asset_cols').value
        .split(',')
        .map(s => s.trim())
        .filter(Boolean);
      const selectedBenchmarkCols = document.getElementById('benchmark_cols').value
        .split(',')
        .map(s => s.trim())
        .filter(Boolean);
      const strategySet = new Set(selectedAssetCols);
      const selectedRiskCols = document.getElementById('risk_asset_cols').value
        .split(',')
        .map(s => s.trim())
        .filter(Boolean)
        .filter(name => strategySet.has(name));
      const selectedSafeCols = document.getElementById('safe_asset_cols').value
        .split(',')
        .map(s => s.trim())
        .filter(Boolean)
        .filter(name => strategySet.has(name));
      const safeAllocationMode = document.getElementById('safe_allocation_mode').value;

      let safeFixedWeights = null;
      if (safeAllocationMode === 'fixed_weight' && selectedSafeCols.length > 0) {
        try {
          const parsed = parseSafeFixedWeights(
            document.getElementById('safe_fixed_weights_text').value
          );
          const safeSet = new Set(selectedSafeCols);
          safeFixedWeights = Object.fromEntries(
            Object.entries(parsed).filter(([name]) => safeSet.has(name))
          );
          const sumW = Object.values(safeFixedWeights).reduce((acc, v) => acc + v, 0);
          if (sumW <= 0) {
            throw new Error('Fixed weights must include at least one safe asset with weight > 0.');
          }
        } catch (err) {
          loading.classList.add('hidden');
          runBtn.disabled = false;
          errorMsg.textContent = err.message || 'Invalid safe fixed weights';
          errorMsg.style.display = 'block';
          return;
        }
      }

      let safeSingleAsset = null;
      if (safeAllocationMode === 'single_asset' && selectedSafeCols.length > 0) {
        const single = (document.getElementById('safe_single_asset').value || '').trim();
        safeSingleAsset = selectedSafeCols.includes(single) ? single : selectedSafeCols[0];
      }

      const overlapRiskSafe = selectedRiskCols.filter(name => selectedSafeCols.includes(name));
      if (overlapRiskSafe.length > 0) {
        loading.classList.add('hidden');
        runBtn.disabled = false;
        errorMsg.textContent =
          'Risk Assets and Safe Assets overlap: ' + overlapRiskSafe.join(', ') + '. Please separate them.';
        errorMsg.style.display = 'block';
        return;
      }

      // 校验：不允许选择未 Process Data 的资产参与回测/基准
      const selectedAll = [...selectedAssetCols, ...selectedBenchmarkCols, ...selectedRiskCols, ...selectedSafeCols];
      const notProcessed = selectedAll
        .filter(n => n)
        .filter((n, idx, arr) => arr.indexOf(n) === idx)
        .filter(name => {
          const a = allAssetsList.find(x => x.name === name);
          return a && !a.processed;
        });

      if (notProcessed.length > 0) {
        loading.classList.add('hidden');
        runBtn.disabled = false;
        errorMsg.textContent =
          'Some selected assets are not processed yet: ' +
          notProcessed.join(', ') +
          '. Please click "Process Data" in Assets Management first.';
        errorMsg.style.display = 'block';
        return;
      }

      const payload = {
        algorithm: document.getElementById('algorithm').value,
        signal_weight_mode: document.getElementById('signal_weight_mode').value,
        start_date: document.getElementById('start_date').value || null,
        end_date: document.getElementById('end_date').value || null,
        initial_capital: parseFloat(document.getElementById('initial_capital').value),
        asset_cols: selectedAssetCols,
        risk_asset_cols: selectedRiskCols,
        safe_asset_cols: selectedSafeCols,
        safe_allocation_mode: safeAllocationMode,
        safe_fixed_weights: safeFixedWeights,
        safe_single_asset: safeSingleAsset,
        benchmark_cols: selectedBenchmarkCols,
        rebalance_interval_days: document.getElementById('rebalance_interval_days').value
          ? parseInt(document.getElementById('rebalance_interval_days').value)
          : null,
        use_trend_model: useTrend,
        model_type: modelType,
        model_lookback_days: document.getElementById('model_lookback_days').value
          ? parseInt(document.getElementById('model_lookback_days').value)
          : 60,
        model_threshold: document.getElementById('model_threshold').value
          ? parseFloat(document.getElementById('model_threshold').value)
          : 0.5,
        model_path: modelPathVal || null,
        max_tilt: document.getElementById('max_tilt').value
          ? parseFloat(document.getElementById('max_tilt').value)
          : 0.1,
        risk_leverage_min: document.getElementById('risk_leverage_min').value
          ? parseFloat(document.getElementById('risk_leverage_min').value)
          : 0.2,
        risk_leverage_max: document.getElementById('risk_leverage_max').value
          ? parseFloat(document.getElementById('risk_leverage_max').value)
          : 1.0,
        risk_leverage_score_lo: document.getElementById('risk_leverage_score_lo').value
          ? parseFloat(document.getElementById('risk_leverage_score_lo').value)
          : 0.2,
        risk_leverage_score_hi: document.getElementById('risk_leverage_score_hi').value
          ? parseFloat(document.getElementById('risk_leverage_score_hi').value)
          : 0.8,
      };

      if (payload.asset_cols.length === 0) {
        payload.asset_cols = null;
      }

      try {
        const res = await fetch('/api/backtest', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.detail || 'Backtest failed');
        }

        const data = await res.json();
        const s = data.stats;
        const metrics = [
          { label: 'Total Return', value: (s['Total Return'] * 100).toFixed(2) + '%' },
          { label: 'CAGR', value: (s['CAGR'] * 100).toFixed(2) + '%' },
          { label: 'Sharpe Ratio', value: s['Sharpe Ratio'].toFixed(2) },
          { label: 'Max Drawdown', value: (s['Max Drawdown'] * 100).toFixed(2) + '%' },
          { label: 'Volatility', value: (s['Volatility'] * 100).toFixed(2) + '%' },
          { label: 'Years', value: s['Years'].toFixed(1) },
        ];

        statsGrid.innerHTML = '';
        metrics.forEach(m => {
          const card = document.createElement('div');
          card.className = 'stat-card';
          card.innerHTML = `<div class='stat-label'>${m.label}</div><div class='stat-value'>${m.value}</div>`;
          statsGrid.appendChild(card);
        });

        plotFrame.src = data.result_url + '?t=' + new Date().getTime();
        resultsPanel.classList.remove('hidden');
        resultsPanel.scrollIntoView({ behavior: 'smooth' });
      } catch (err) {
        errorMsg.textContent = err.message;
        errorMsg.style.display = 'block';
      } finally {
        loading.classList.add('hidden');
        runBtn.disabled = false;
      }
    }

    document.addEventListener('change', (e) => {
      if (e.target && e.target.id === 'select-all-assets') {
        const checked = e.target.checked;
        const checkboxes = document.querySelectorAll('.asset-select-checkbox');
        checkboxes.forEach(cb => { cb.checked = checked; });
      }
    });

    document.getElementById('backtest-form').onsubmit = runBacktest;
    document.getElementById('refresh-assets-btn').onclick = loadAssets;
    document.getElementById('download-assets-btn').onclick = downloadAssets;
    document.getElementById('process-assets-btn').onclick = processAssets;
    document.getElementById('asset-form').onsubmit = saveAsset;
    document.getElementById('new-asset-btn').onclick = () => {
      document.getElementById('asset_original_name').value = '';
      document.getElementById('asset_name').value = '';
      document.getElementById('asset_ticker').value = '';
      document.getElementById('asset_kind').value = 'price';
      document.getElementById('asset_engine').value = '';
      document.getElementById('asset_duration').value = '';
      document.getElementById('asset_initial_start_date').value = '1985-01-02';
    };

    loadAlgorithms();
    loadAssets();
    loadTrendModels();
  </script>
</body>
</html>
